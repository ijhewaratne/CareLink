// =============================================================================
// CareLink Database Schema - Location-aware Care Services Marketplace
// Location: Sri Lanka | Compliance: Sri Lanka PDPA
// =============================================================================
// CRITICAL TERMINOLOGY RULES:
// - "Customer" or "Care Recipient" (NOT "Patient")
// - "Provider" (NOT "Nurse")
// - "Assistance" or "Service" (NOT "Treatment")
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // Enable PostGIS extension for geospatial queries
  extensions = [postgis(version: "3.3")]
}

// =============================================================================
// ENUMS
// =============================================================================

enum UserRole {
  CUSTOMER    // Requests care services
  PROVIDER    // Delivers care services
  ADMIN       // Platform administrators
  SUPER_ADMIN // Full system access
  
  @@map("user_role")
}

enum BookingStatus {
  PENDING      // Initial request created
  MATCHED      // Provider assigned
  CONFIRMED    // Both parties confirmed
  IN_PROGRESS  // Service actively being delivered
  COMPLETED    // Service finished successfully
  CANCELLED    // Cancelled by either party
  DISPUTED     // Under dispute resolution
  REFUNDED     // Payment refunded
  
  @@map("booking_status")
}

enum DocumentType {
  NIC_FRONT           // National Identity Card - Front
  NIC_BACK            // National Identity Card - Back
  POLICE_CLEARANCE    // Police clearance certificate
  MEDICAL_CERTIFICATE // Health fitness certificate
  TRAINING_CERT       // Care training certificates
  REFERENCE_LETTER    // Character references
  PROFILE_PHOTO       // Provider profile photo
  
  @@map("document_type")
}

enum VerificationStatus {
  PENDING     // Document uploaded, awaiting review
  UNDER_REVIEW // Being reviewed by admin
  VERIFIED    // Approved
  REJECTED    // Rejected with reason
  EXPIRED     // Document expired
  
  @@map("verification_status")
}

enum PaymentStatus {
  PENDING
  HELD_IN_ESCROW  // Funds held until service completion
  RELEASED        // Released to provider
  REFUNDED        // Refunded to customer
  FAILED
  
  @@map("payment_status")
}

// =============================================================================
// CORE USER MODELS
// =============================================================================

/// Users table stores authentication data only
/// PII is stored in separate Profiles table with additional encryption
/// Firebase UID links to external authentication provider
model User {
  id            String    @id @default(uuid()) @db.Uuid
  firebaseUid   String    @unique @map("firebase_uid") @db.VarChar(128)
  phoneNumber   String    @unique @map("phone_number") @db.VarChar(20)
  phoneVerified Boolean   @default(false) @map("phone_verified")
  email         String?   @unique @db.VarChar(255)
  emailVerified Boolean   @default(false) @map("email_verified")
  role          UserRole  @default(CUSTOMER)
  isActive      Boolean   @default(true) @map("is_active")
  lastLoginAt   DateTime? @map("last_login_at")
  
  // Audit fields
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at") // Soft delete
  
  // Relations
  profile       Profile?
  customerBookings Booking[] @relation("CustomerBookings")
  providerBookings Booking[] @relation("ProviderBookings")
  providerSkills   ProviderSkill[]
  documents        VerificationDoc[]
  reviewsGiven     Review[] @relation("ReviewAuthor")
  reviewsReceived  Review[] @relation("ReviewTarget")
  auditLogs        AuditLog[]
  
  // Indexes for common queries
  @@index([phoneNumber])
  @@index([firebaseUid])
  @@index([role, isActive])
  @@index([deletedAt]) // For soft delete filtering
  @@index([createdAt])
  @@map("users")
}

/// Profiles table stores PII with encryption
/// CRITICAL: NIC number is encrypted at rest using database-level encryption
/// Location stored as PostGIS geography point for geospatial queries
model Profile {
  id               String   @id @default(uuid()) @db.Uuid
  userId           String   @unique @map("user_id") @db.Uuid
  
  // Personal Information - ENCRYPTED FIELDS
  /// NIC number encrypted using pgcrypto extension
  /// Encryption key managed via environment variable
  nicEncrypted     String   @map("nic_encrypted") @db.Text
  nicHash          String   @unique @map("nic_hash") @db.VarChar(64) // For deduplication checks without decrypting
  
  fullName         String   @map("full_name") @db.VarChar(255)
  displayName      String?  @map("display_name") @db.VarChar(100)
  dateOfBirth      DateTime? @map("date_of_birth") @db.Date
  gender           String?  @db.VarChar(20)
  
  // Address Information
  addressLine1     String   @map("address_line1") @db.VarChar(255)
  addressLine2     String?  @map("address_line2") @db.VarChar(255)
  city             String   @db.VarChar(100)
  district         String   @db.VarChar(100) // Sri Lanka districts
  province         String   @db.VarChar(100) // Sri Lanka provinces
  postalCode       String?  @map("postal_code") @db.VarChar(20)
  
  // Geolocation - PostGIS geography point
  /// Stored as SRID 4326 (WGS 84) for global GPS coordinates
  /// Use ST_DWithin for proximity searches
  location         Unsupported("geography(Point, 4326)")?
  
  // Provider-specific fields
  isAvailable      Boolean  @default(false) @map("is_available")
  bio              String?  @db.Text
  languages        String[] @default([]) // Languages spoken
  
  // Trust Score (0-100)
  /// Calculated from: completion rate, ratings, verification status, response time
  trustScore       Float    @default(0) @map("trust_score")
  totalServices    Int      @default(0) @map("total_services")
  responseTimeMin  Int?     @map("response_time_min") // Average response time in minutes
  
  // Emergency Contact
  emergencyName    String?  @map("emergency_name") @db.VarChar(255)
  emergencyPhone   String?  @map("emergency_phone") @db.VarChar(20)
  emergencyRelation String? @map("emergency_relation") @db.VarChar(50)
  
  // Audit fields
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  
  // Relations
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Indexes
  @@index([trustScore])
  @@index([isAvailable, trustScore])
  @@index([district, city])
  @@index([nicHash]) // For duplicate NIC detection
  
  // GiST index for geospatial queries - enables fast proximity searches
  @@index([location], type: Gist)
  
  @@map("profiles")
}

// =============================================================================
// SERVICE & CAPABILITY MODELS
// =============================================================================

/// Service Categories define available service types
/// Capability-based design allows future service expansion
/// Each category has required capabilities that providers must have
model ServiceCategory {
  id              String   @id @default(uuid()) @db.Uuid
  
  // Service identification
  slug            String   @unique @db.VarChar(100) // URL-friendly identifier
  nameEn          String   @map("name_en") @db.VarChar(255) // English name
  nameSi          String?  @map("name_si") @db.VarChar(255) // Sinhala name
  nameTa          String?  @map("name_ta") @db.VarChar(255) // Tamil name
  
  // Service details
  description     String   @db.Text
  shortDescription String  @map("short_description") @db.VarChar(500)
  
  // Pricing
  basePrice       Decimal  @map("base_price") @db.Decimal(10, 2)
  priceUnit       String   @map("price_unit") @db.VarChar(50) // "per_hour", "per_day", "per_visit"
  
  // Capability requirements
  /// JSON array of required capability slugs
  /// Example: ["hospital_attendant", "mobility_assistance"]
  requiredCapabilities String @map("required_capabilities") @db.JsonB
  
  // Service configuration
  minDurationHours Int     @default(4) @map("min_duration_hours")
  maxDurationHours Int     @default(24) @map("max_duration_hours")
  requiresVerification String[] @default([]) @map("requires_verification") // Required document types
  
  // Display
  iconUrl         String?  @map("icon_url") @db.VarChar(500)
  displayOrder    Int      @default(0) @map("display_order")
  isActive        Boolean  @default(true) @map("is_active")
  
  // Audit fields
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  // Relations
  providerSkills  ProviderSkill[]
  bookings        Booking[]
  
  // Indexes
  @@index([slug])
  @@index([isActive, displayOrder])
  @@index([requiredCapabilities], type: Gin) // GIN index for JSONB queries
  
  @@map("service_categories")
}

/// Provider Skills - Junction table linking providers to their capabilities
/// Includes trust scores per skill for granular matching
model ProviderSkill {
  id                String   @id @default(uuid()) @db.Uuid
  providerId        String   @map("provider_id") @db.Uuid
  serviceCategoryId String   @map("service_category_id") @db.Uuid
  
  // Skill metrics
  isVerified        Boolean  @default(false) @map("is_verified")
  skillTrustScore   Float    @default(0) @map("skill_trust_score") // 0-100
  yearsExperience   Int?     @map("years_experience")
  
  // Performance metrics
  totalBookings     Int      @default(0) @map("total_bookings")
  completedBookings Int      @default(0) @map("completed_bookings")
  cancelledBookings Int      @default(0) @map("cancelled_bookings")
  ratingAverage     Float    @default(0) @map("rating_average")
  
  // Availability for this skill
  isActive          Boolean  @default(true) @map("is_active")
  
  // Audit fields
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  // Relations
  provider          User             @relation(fields: [providerId], references: [id], onDelete: Cascade)
  serviceCategory   ServiceCategory  @relation(fields: [serviceCategoryId], references: [id], onDelete: Cascade)
  
  // Constraints
  @@unique([providerId, serviceCategoryId])
  
  // Indexes for provider matching
  @@index([serviceCategoryId, isActive, skillTrustScore])
  @@index([providerId, isActive])
  @@index([skillTrustScore])
  
  @@map("provider_skills")
}

// =============================================================================
// BOOKING MODELS
// =============================================================================

/// Bookings represent service requests from customers
/// Location stored for both customer and service delivery location
model Booking {
  id                String        @id @default(uuid()) @db.Uuid
  bookingReference  String        @unique @map("booking_reference") @db.VarChar(20) // Human-readable reference
  
  // Parties
  customerId        String        @map("customer_id") @db.Uuid
  providerId        String?       @map("provider_id") @db.Uuid // Null until matched
  
  // Service details
  serviceCategoryId String        @map("service_category_id") @db.Uuid
  status            BookingStatus @default(PENDING)
  
  // Timing
  scheduledDate     DateTime      @map("scheduled_date") @db.Date
  startTime         DateTime      @map("start_time") // Actual start
  endTime           DateTime?     @map("end_time") // Actual end
  durationHours     Int           @map("duration_hours")
  
  // Location - Service delivery location (may differ from customer home)
  locationAddress   String        @map("location_address") @db.VarChar(500)
  locationCity      String        @map("location_city") @db.VarChar(100)
  locationDistrict  String        @map("location_district") @db.VarChar(100)
  /// PostGIS geography point for proximity matching
  locationGeo       Unsupported("geography(Point, 4326)")? @map("location_geo")
  
  // Care Recipient details (may differ from customer)
  careRecipientName   String?     @map("care_recipient_name") @db.VarChar(255)
  careRecipientAge    Int?        @map("care_recipient_age")
  careRecipientGender String?     @map("care_recipient_gender") @db.VarChar(20)
  specialRequirements String?     @map("special_requirements") @db.Text
  
  // Pricing
  baseAmount        Decimal       @map("base_amount") @db.Decimal(10, 2)
  platformFee       Decimal       @map("platform_fee") @db.Decimal(10, 2)
  totalAmount       Decimal       @map("total_amount") @db.Decimal(10, 2)
  currency          String        @default("LKR") @db.VarChar(3)
  
  // Payment
  paymentStatus     PaymentStatus @default(PENDING) @map("payment_status")
  
  // Status tracking
  matchedAt         DateTime?     @map("matched_at")
  confirmedAt       DateTime?     @map("confirmed_at")
  startedAt         DateTime?     @map("started_at")
  completedAt       DateTime?     @map("completed_at")
  cancelledAt       DateTime?     @map("cancelled_at")
  cancellationReason String?      @map("cancellation_reason") @db.Text
  cancelledBy       String?       @map("cancelled_by") @db.Uuid
  
  // Provider assignment tracking
  assignmentAttempts Int          @default(0) @map("assignment_attempts")
  lastAssignmentAt   DateTime?    @map("last_assignment_at")
  
  // Audit fields
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  deletedAt         DateTime?     @map("deleted_at") // Soft delete
  
  // Relations
  customer          User          @relation("CustomerBookings", fields: [customerId], references: [id])
  provider          User?         @relation("ProviderBookings", fields: [providerId], references: [id])
  serviceCategory   ServiceCategory @relation(fields: [serviceCategoryId], references: [id])
  review            Review?
  
  // Indexes for common queries
  @@index([customerId, status])
  @@index([providerId, status])
  @@index([status, scheduledDate])
  @@index([serviceCategoryId, status])
  @@index([bookingReference])
  @@index([createdAt])
  @@index([deletedAt])
  
  // GiST index for geospatial matching
  @@index([locationGeo], type: Gist)
  
  @@map("bookings")
}

// =============================================================================
// VERIFICATION & DOCUMENT MODELS
// =============================================================================

/// Verification Documents - Stores only metadata
/// Actual files stored in cloud storage (S3, Google Cloud, etc.)
/// Document URLs are signed/short-lived for security
model VerificationDoc {
  id              String             @id @default(uuid()) @db.Uuid
  userId          String             @map("user_id") @db.Uuid
  
  // Document classification
  documentType    DocumentType       @map("document_type")
  status          VerificationStatus @default(PENDING)
  
  // Cloud storage references - NOT the actual files
  /// Format: {provider}://{bucket}/{path}
  /// Example: s3://carelink-docs/verification/user-123/nic-front-456.jpg
  storageProvider String             @map("storage_provider") @db.VarChar(50)
  storageBucket   String             @map("storage_bucket") @db.VarChar(100)
  storagePath     String             @map("storage_path") @db.VarChar(500)
  storageUrl      String?            @map("storage_url") @db.VarChar(1000) // Signed URL (temporary)
  urlExpiresAt    DateTime?          @map("url_expires_at")
  
  // Document metadata
  fileName        String             @map("file_name") @db.VarChar(255)
  fileSize        Int                @map("file_size") // Bytes
  mimeType        String             @map("mime_type") @db.VarChar(100)
  
  // Verification tracking
  uploadedAt      DateTime           @default(now()) @map("uploaded_at")
  verifiedAt      DateTime?          @map("verified_at")
  verifiedBy      String?            @map("verified_by") @db.Uuid // Admin user ID
  rejectionReason String?            @map("rejection_reason") @db.Text
  expiresAt       DateTime?          @map("expires_at") // For documents with expiry
  
  // OCR/Extraction results (encrypted if contains PII)
  extractedData   String?            @map("extracted_data") @db.Text // JSON string, encrypted
  
  // Audit fields
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")
  
  // Relations
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Indexes
  @@index([userId, documentType])
  @@index([status, documentType])
  @@index([verifiedBy])
  @@index([expiresAt])
  @@index([createdAt])
  
  @@map("verification_docs")
}

// =============================================================================
// REVIEW & RATING MODELS
// =============================================================================

/// Reviews for completed bookings
/// One review per booking, can be from customer (about provider) or vice versa
model Review {
  id          String   @id @default(uuid()) @db.Uuid
  bookingId   String   @unique @map("booking_id") @db.Uuid
  authorId    String   @map("author_id") @db.Uuid // Who wrote the review
  targetId    String   @map("target_id") @db.Uuid // Who is being reviewed
  
  // Rating (1-5)
  rating      Int      @db.SmallInt
  
  // Review content
  title       String?  @db.VarChar(200)
  comment     String?  @db.Text
  
  // Categories
  punctualityRating   Int? @map("punctuality_rating") @db.SmallInt
  professionalismRating Int? @map("professionalism_rating") @db.SmallInt
  communicationRating Int? @map("communication_rating") @db.SmallInt
  
  // Moderation
  isVisible   Boolean  @default(true) @map("is_visible")
  moderatedAt DateTime? @map("moderated_at")
  moderatedBy String?   @map("moderated_by") @db.Uuid
  
  // Audit fields
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // Relations
  booking     Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  author      User     @relation("ReviewAuthor", fields: [authorId], references: [id])
  target      User     @relation("ReviewTarget", fields: [targetId], references: [id])
  
  // Indexes
  @@index([targetId, isVisible])
  @@index([authorId])
  @@index([rating])
  @@index([createdAt])
  
  @@map("reviews")
}

// =============================================================================
// AUDIT & COMPLIANCE MODELS
// =============================================================================

/// Audit Log for PDPA compliance and security tracking
/// Records all significant actions for accountability
model AuditLog {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String?  @map("user_id") @db.Uuid // Nullable for system actions
  
  // Action details
  action      String   @db.VarChar(100) // e.g., "BOOKING_CREATED", "PROFILE_UPDATED"
  entityType  String   @map("entity_type") @db.VarChar(50) // e.g., "Booking", "Profile"
  entityId    String?  @map("entity_id") @db.Uuid
  
  // Request context
  ipAddress   String?  @map("ip_address") @db.VarChar(45) // IPv6 compatible
  userAgent   String?  @map("user_agent") @db.Text
  
  // Change details (for updates)
  oldValues   String?  @map("old_values") @db.Text // JSON of previous values (PII masked)
  newValues   String?  @map("new_values") @db.Text // JSON of new values (PII masked)
  
  // Reason for action (for sensitive operations)
  reason      String?  @db.Text
  
  // Timestamp
  createdAt   DateTime @default(now()) @map("created_at")
  
  // Relations
  user        User?    @relation(fields: [userId], references: [id])
  
  // Indexes for audit queries
  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@index([entityType, entityId])
  @@index([createdAt])
  
  @@map("audit_logs")
}

/// Data Access Log for PDPA compliance
/// Records when PII is accessed (read operations)
model PiiAccessLog {
  id          String   @id @default(uuid()) @db.Uuid
  
  // Who accessed
  accessorId  String   @map("accessor_id") @db.Uuid // User who accessed
  accessorRole String  @map("accessor_role") @db.VarChar(50)
  
  // What was accessed
  subjectId   String   @map("subject_id") @db.Uuid // User whose data was accessed
  dataType    String   @map("data_type") @db.VarChar(50) // e.g., "nic", "address", "phone"
  
  // Access context
  purpose     String   @db.VarChar(255) // Reason for access (PDPA requirement)
  legalBasis  String   @map("legal_basis") @db.VarChar(100) // e.g., "consent", "contract", "legal_obligation"
  
  // Request context
  ipAddress   String?  @map("ip_address") @db.VarChar(45)
  endpoint    String?  @db.VarChar(500) // API endpoint accessed
  
  // Timestamp
  accessedAt  DateTime @default(now()) @map("accessed_at")
  
  // Indexes for compliance reports
  @@index([subjectId, accessedAt])
  @@index([accessorId, accessedAt])
  @@index([dataType, accessedAt])
  @@index([accessedAt])
  
  @@map("pii_access_logs")
}

// =============================================================================
// CONFIGURATION & LOOKUP TABLES
// =============================================================================

/// System configuration values
model SystemConfig {
  id          String   @id @default(uuid()) @db.Uuid
  key         String   @unique @db.VarChar(100)
  value       String   @db.Text
  dataType    String   @map("data_type") @db.VarChar(20) // "string", "number", "boolean", "json"
  description String?  @db.Text
  isEncrypted Boolean  @default(false) @map("is_encrypted")
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@map("system_config")
}

/// Sri Lanka districts lookup for validation and filtering
model District {
  id          String   @id @default(uuid()) @db.Uuid
  nameEn      String   @unique @map("name_en") @db.VarChar(100)
  nameSi      String?  @map("name_si") @db.VarChar(100)
  nameTa      String?  @map("name_ta") @db.VarChar(100)
  province    String   @db.VarChar(100)
  isActive    Boolean  @default(true) @map("is_active")
  
  createdAt   DateTime @default(now()) @map("created_at")
  
  @@map("districts")
}

// =============================================================================
// NOTES ON IMPLEMENTATION
// =============================================================================
// 1. ENCRYPTION SETUP:
//    - Enable pgcrypto extension: CREATE EXTENSION IF NOT EXISTS pgcrypto;
//    - NIC encryption uses: pgp_sym_encrypt(nic, '${ENCRYPTION_KEY}')
//    - NIC decryption uses: pgp_sym_decrypt(nic_encrypted, '${ENCRYPTION_KEY}')
//
// 2. POSTGIS SETUP:
//    - Enable PostGIS: CREATE EXTENSION IF NOT EXISTS postgis;
//    - Insert location: ST_SetSRID(ST_MakePoint(lng, lat), 4326)::geography
//    - Find nearby: ST_DWithin(location, ST_MakePoint(lng, lat)::geography, distance_meters)
//
// 3. SOFT DELETE PATTERN:
//    - All queries should filter: WHERE deletedAt IS NULL
//    - Use middleware or repository pattern to enforce this
//
// 4. TRUST SCORE CALCULATION:
//    - Run as scheduled job or trigger
//    - Formula: (completion_rate * 0.4) + (avg_rating * 0.3) + (verification * 0.2) + (response_time * 0.1)
//
// 5. PDPA COMPLIANCE:
//    - Log all PII access via PiiAccessLog
//    - Implement data retention policies
//    - Provide data export/deletion endpoints
// =============================================================================
